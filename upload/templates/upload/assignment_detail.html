<!-- upload/templates/upload/assignment_detail.html -->

{% extends 'upload/base.html' %}
{% load crispy_forms_tags %}
{% load dict_extras %}

{% block content %}
<div class="content-container">
    <a href="{% url 'upload:subject_detail' subject_name=assignment.subject.name %}" class="btn btn-secondary mb-4">
        &larr; Back
    </a>
    <h2>{{ assignment.name }}</h2>
    <p><strong>Deadline:</strong> {{ assignment.deadline }}</p>
    <p><strong>Max Points:</strong> {{ assignment.max_points }}</p>
    <p><strong>Max Uploads:</strong> {{ assignment.max_uploads }}</p>
    <p>{{ assignment.get_description_markdown }}</p>
    <hr>
    <h3>Latest Upload</h3>
    {% if latest_document %}
        <!-- Отображаем дату/время последней загрузки как ссылку на страницу с кодом -->
        <p>
            <strong>Uploaded at:</strong>
            <a href="{% url 'upload:document_detail' pk=latest_document.pk %}">
                {{ latest_document.uploaded_at|date:"d.m.Y H:i" }}
            </a>

            <!-- Кнопка "Download" -->
            <a href="{{ latest_document.document.url }}" class="btn btn-sm btn-primary" download>
                Download
            </a>
        </p>

        <!-- Если есть результат теста, покажем -->
        {% if latest_document.test_result %}
            <p>
                <span class="badge {% if 'Passed' in latest_document.test_result %}bg-success{% else %}bg-danger{% endif %}">
                    {{ latest_document.test_result }}
                </span>
                <span class="badge bg-info">
                    Grade: {{ latest_document.grade }} / {{ assignment.max_points }}
                </span>
            </p>
        {% endif %}

    {% else %}
        <p>No files have been uploaded yet.</p>
    {% endif %}

    {% if is_teacher %}
        <a href="{% url 'upload:upload_test_file' subject_abbr=assignment.subject.name assignment_number=assignment.number %}"
           class="btn btn-secondary mb-4">
            Upload Test File
        </a>
    {% endif %}

    {% if form %}
        <h3>Upload File</h3>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form|crispy }}
            <button type="submit" class="btn btn-primary">Upload</button>
        </form>
    {% else %}
        <p class="text-danger">You cannot upload more files (limit reached).</p>
    {% endif %}
</div>
{% endblock %}